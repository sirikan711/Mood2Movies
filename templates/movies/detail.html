{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto bg-gray-800 rounded-xl overflow-hidden shadow-2xl">
    <div class="md:flex">
        <!-- Movie Poster -->
        <div class="md:flex-shrink-0 relative group">
             <img class="h-full w-full object-cover md:w-96" src="{{ movie_tmdb.poster_url }}" alt="{{ movie_tmdb.title }}">
        </div>

        <!-- Movie Info -->
        <div class="p-8 md:flex-grow flex flex-col">
            <!-- Title & Year -->
            <h1 class="text-4xl font-bold mb-2">{{ movie_tmdb.title }} <span class="text-gray-400 text-2xl">({{ movie_tmdb.release_date|slice:":4" }})</span></h1>
            
            <!-- Genres & Rating -->
            <div class="flex flex-wrap gap-2 mb-6">
                {% for genre in movie_tmdb.genres %}
                <span class="bg-gray-700 text-sm px-3 py-1 rounded-full">{{ genre }}</span>
                {% endfor %}
                {% if movie_tmdb.vote_average %}
                <span class="bg-yellow-500 text-gray-900 text-sm px-3 py-1 rounded-full font-bold">‚òÖ {{ movie_tmdb.vote_average|floatformat:1 }} TMDb</span>
                {% endif %}
            </div>

            <!-- Synopsis -->
            <h2 class="text-xl font-semibold mb-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠</h2>
            <p class="text-gray-300 leading-relaxed mb-8 flex-grow">
                {{ movie_tmdb.overview|default:"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" }}
            </p>

            <!-- Action Buttons Area -->
            <div class="flex flex-wrap gap-4 mt-auto pt-6 border-t border-gray-700">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
                <a href="{% url 'add_review' movie_tmdb.tmdb_id %}" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition flex items-center transform hover:scale-105 shadow-lg">
                    <span class="mr-2 text-xl">üé≠</span> ‡πÅ‡∏õ‡∏∞‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                </a>
                
                {% if user.is_authenticated %}
                    <!-- ‡∏õ‡∏∏‡πà‡∏° Fav -->
                    <button id="fav-btn" data-tmdb-id="{{ movie_tmdb.tmdb_id }}" 
                            class="bg-gray-700 hover:bg-pink-600 text-white font-bold py-3 px-5 rounded-lg transition flex items-center transform hover:scale-105 shadow-md {% if is_favorited %}bg-pink-600{% endif %}">
                        <span id="fav-icon" class="mr-2 text-xl">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span> 
                        <span id="fav-text">{% if is_favorited %}Fav ‡πÅ‡∏•‡πâ‡∏ß{% else %}Favorite{% endif %}</span>
                    </button>

                    <!-- ‡∏õ‡∏∏‡πà‡∏° Bookmark -->
                    <button id="bookmark-btn" data-tmdb-id="{{ movie_tmdb.tmdb_id }}"
                            class="bg-gray-700 hover:bg-blue-600 text-white font-bold py-3 px-5 rounded-lg transition flex items-center transform hover:scale-105 shadow-md {% if is_bookmarked %}bg-blue-600{% endif %}">
                         <span id="bookmark-icon" class="mr-2 text-xl">{% if is_bookmarked %}üîñ{% else %}üè∑Ô∏è{% endif %}</span>
                         <span id="bookmark-text">{% if is_bookmarked %}‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß{% else %}‡∏î‡∏π‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á{% endif %}</span>
                    </button>
                {% else %}
                    <!-- ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
                    <a href="{% url 'login' %}?next={{ request.path }}" class="bg-gray-700 hover:bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded-lg transition flex items-center">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="p-8 bg-gray-900 border-t border-gray-700 mt-8">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <span class="mr-2">üí¨</span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ Mood2Movie
            <span class="ml-3 text-sm bg-gray-700 text-gray-300 px-3 py-1 rounded-full">{{ reviews.count }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</span>
        </h2>

        {% if reviews %}
            <div class="grid gap-6 md:grid-cols-2">
                {% for review in reviews %}
                <div class="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700 hover:border-gray-600 transition relative group">
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center">
                            <!-- Avatar/Initial -->
                            <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center font-bold text-gray-900 mr-3 shadow-sm overflow-hidden">
                                {% if review.user.profile.avatar %}
                                    <img src="{{ review.user.profile.avatar.url }}" class="w-full h-full object-cover">
                                {% else %}
                                    {{ review.user.username|slice:":1"|upper }}
                                {% endif %}
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-200">{{ review.user.username }}</h4>
                                <p class="text-xs text-gray-500">{{ review.created_at|date:"d M Y" }}</p>
                            </div>
                        </div>
                        
                        <!-- Rating & Actions Container -->
                        <div class="flex items-center gap-3">
                            {% if review.rating %}
                            <div class="bg-gray-900/50 px-3 py-1 rounded-full text-sm font-bold text-yellow-400 border border-yellow-500/30">
                                ‚òÖ {{ review.rating|floatformat:1 }}
                            </div>
                            {% endif %}

                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö) -->
                            {% if request.user == review.user %}
                            <div class="flex items-center gap-1">
                                <a href="{% url 'edit_review' review.id %}" class="text-gray-400 hover:text-blue-400 p-1 transition" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                </a>
                                <a href="{% url 'delete_review' review.id %}" 
                                   onclick="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠?')"
                                   class="text-gray-400 hover:text-red-400 p-1 transition" title="‡∏•‡∏ö">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Mood Badge -->
                    {% if review.primary_mood %}
                    <div class="mb-4">
                        <span class="inline-flex items-center bg-blue-900/50 text-blue-200 text-sm px-3 py-1.5 rounded-lg font-semibold tracking-wide border border-blue-500/30">
                            <span class="mr-1.5">
                                {% if 'Happy' in review.primary_mood.name %}üòä
                                {% elif 'Sad' in review.primary_mood.name %}üò≠
                                {% elif 'Scary' in review.primary_mood.name %}üò®
                                {% elif 'Surprised' in review.primary_mood.name %}üò≤
                                {% elif 'Heartwarming' in review.primary_mood.name %}ü•∞
                                {% elif 'Tense' in review.primary_mood.name %}üò¨
                                {% elif 'Funny' in review.primary_mood.name %}ü§£
                                {% elif 'Relaxing' in review.primary_mood.name %}üòå
                                {% else %}üé≠{% endif %}
                            </span>
                            {{ review.primary_mood.name }} (‡∏£‡∏∞‡∏î‡∏±‡∏ö {{ review.mood_intensity }}/5)
                        </span>
                    </div>
                    {% endif %}

                    <!-- Comment -->
                    {% if review.review_text %}
                    <p class="text-gray-300 italic leading-relaxed">"{{ review.review_text }}"</p>
                    {% else %}
                    <p class="text-gray-500 italic">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16 bg-gray-800/50 rounded-xl border-2 border-dashed border-gray-700">
                <p class="text-gray-400 text-xl mb-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÅ‡∏õ‡∏∞‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ üòÖ</p>
                <a href="{% url 'add_review' movie_tmdb.tmdb_id %}" class="inline-block bg-yellow-500 text-gray-900 px-8 py-3 rounded-lg font-bold hover:bg-yellow-400 transition shadow-lg">
                    ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏™‡∏¥!
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript for Ajax (Fav/Bookmark) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const favBtn = document.getElementById('fav-btn');
    const bookmarkBtn = document.getElementById('bookmark-btn');

    async function toggleAction(url, btn, iconSpan, textSpan, activeClass, activeIcon, inactiveIcon, activeText, inactiveText) {
        if (btn.disabled) return;
        btn.disabled = true;
        btn.style.opacity = '0.7';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            if (data.status === 'added') {
                btn.classList.add(activeClass);
                btn.classList.remove('bg-gray-700');
                iconSpan.textContent = activeIcon;
                textSpan.textContent = activeText;
            } else if (data.status === 'removed') {
                btn.classList.remove(activeClass);
                btn.classList.add('bg-gray-700');
                iconSpan.textContent = inactiveIcon;
                textSpan.textContent = inactiveText;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        } finally {
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }

    if (favBtn) {
        favBtn.addEventListener('click', function() {
            toggleAction(
                `/movies/movie/${this.dataset.tmdbId}/favorite/`, 
                this, document.getElementById('fav-icon'), document.getElementById('fav-text'),
                'bg-pink-600', '‚ù§Ô∏è', 'ü§ç', 'Fav ‡πÅ‡∏•‡πâ‡∏ß', 'Favorite'
            );
        });
    }

    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', function() {
            toggleAction(
                `/movies/movie/${this.dataset.tmdbId}/bookmark/`,
                this, document.getElementById('bookmark-icon'), document.getElementById('bookmark-text'),
                'bg-blue-600', 'üîñ', 'üè∑Ô∏è', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '‡∏î‡∏π‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á'
            );
        });
    }
});
</script>
{% endblock %}